services:
  # ç™»å½•æœåŠ¡ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
  login:
    image: jiangbkvir/tg-name-updater:latest
    container_name: tg-name-updater-login
    stdin_open: true
    tty: true
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./session:/app/session
      - /var/run/docker.sock:/var/run/docker.sock
      - ./:/app/project
    working_dir: /app/project
    # è¦†ç›– entrypointï¼Œç›´æ¥è¿è¡Œç™»å½•ä»£ç 
    entrypoint: [""]
    command: >
      python3 -c "
      from telethon import TelegramClient
      from telethon.errors import SessionPasswordNeededError
      import os
      import asyncio
      import subprocess

      async def login():
          client = TelegramClient('/app/session/tg_name_updater', int(os.getenv('API_ID')), os.getenv('API_HASH'))
          await client.connect()

          if not await client.is_user_authorized():
              print('ğŸ“± è¯·è¾“å…¥æ‰‹æœºå·ï¼ˆæ ¼å¼ï¼š+8613800138000ï¼‰')
              phone = input('æ‰‹æœºå·: ')

              print('ğŸ” æ­£åœ¨å‘é€éªŒè¯ç ...')
              await client.send_code_request(phone)

              print('ğŸ“¨ è¯·è¾“å…¥ Telegram å‘é€çš„éªŒè¯ç ï¼š')
              code = input('éªŒè¯ç : ')

              try:
                  await client.sign_in(phone, code)
              except SessionPasswordNeededError:
                  print('ğŸ”’ è´¦å·å¼€å¯äº†ä¸¤æ­¥éªŒè¯')
                  print('ğŸ”‘ è¯·è¾“å…¥ä¸¤æ­¥éªŒè¯å¯†ç ï¼š')
                  password = input('å¯†ç : ')
                  await client.sign_in(password=password)

          me = await client.get_me()
          print(f'âœ… ç™»å½•æˆåŠŸ! ç”¨æˆ·: {me.first_name}')
          print('ğŸ’¾ Session æ–‡ä»¶å·²ä¿å­˜')
          await client.disconnect()

          print('ğŸš€ æ­£åœ¨å¯åŠ¨ä¸»æœåŠ¡...')
          result = subprocess.run(['docker', 'compose', 'up', '-d'], capture_output=True, text=True)
          if result.returncode == 0:
              print('âœ… ä¸»æœåŠ¡å·²å¯åŠ¨!')
              print('ğŸ“Š æŸ¥çœ‹æ—¥å¿—: docker logs -f tg-name-updater')
          else:
              print('âŒ å¯åŠ¨å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œ: docker compose up -d')
              print(result.stderr)

      asyncio.run(login())
      "
